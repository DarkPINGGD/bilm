<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Admin Panel</title>
</head>
<body>

<h1>Admin Panel</h1>

<input id="pass" type="password" placeholder="Admin Password">
<button id="loginBtn">Login</button>

<div id="panel"></div>

<script>
const PASSWORD = "1234";
let records = JSON.parse(localStorage.getItem("records")) || [];
let levels = JSON.parse(localStorage.getItem("levels")) || [];
let leaderboard = JSON.parse(localStorage.getItem("leaderboard")) || [];

document.getElementById("loginBtn").addEventListener("click", login);

function login() {
  const passValue = document.getElementById("pass").value;
  const panel = document.getElementById("panel");
  
  if (passValue !== PASSWORD) {
    alert("Wrong password");
    return;
  }

  // Panel içeriği
  let html = "<h2>Pending Records</h2>";
  if (records.length === 0) {
    html += "<p>No records yet.</p>";
  } else {
    records.forEach((r, i) => {
      html += `<div style="border:1px solid #aaa; padding:10px; margin:10px 0">
        <b>${r.nick}</b> — ${r.levelId} (${r.progress}%)
        <br>
        <a href="${r.yt}" target="_blank">YouTube</a> |
        <a href="${r.raw}" target="_blank">Raw</a>
        <br>
        ${r.approved ? "APPROVED" : `<button onclick="approve(${i})">Approve</button> <button onclick="reject(${i})">Reject</button>`}
      </div>`;
    });
  }

  html += `<hr>
    <h2>Add Level</h2>
    <input id="levelRank" placeholder="Rank"><br>
    <input id="levelId" placeholder="Level ID"><br>
    <input id="levelName" placeholder="Level Name"><br>
    <input id="levelCreator" placeholder="Creator"><br>
    <input id="levelPoints" placeholder="Points"><br>
    <button onclick="addLevel()">Add Level</button>
    <div id="levelList"></div>
  `;

  panel.innerHTML = html;
  renderLevels();
}

// Level ekleme
function addLevel() {
  const rank = document.getElementById("levelRank").value;
  const id = document.getElementById("levelId").value;
  const name = document.getElementById("levelName").value;
  const creator = document.getElementById("levelCreator").value;
  const points = document.getElementById("levelPoints").value;

  if (!rank || !id || !name || !creator || !points) {
    alert("All fields required");
    return;
  }

  levels.push({ rank: Number(rank), id: id.toString(), name, creator, points: Number(points) });
  levels.sort((a, b) => a.rank - b.rank);
  localStorage.setItem("levels", JSON.stringify(levels));
  alert("LEVEL ADDED SUCCESSFULLY");
  
  // Inputları temizle
  document.getElementById("levelRank").value = "";
  document.getElementById("levelId").value = "";
  document.getElementById("levelName").value = "";
  document.getElementById("levelCreator").value = "";
  document.getElementById("levelPoints").value = "";

  renderLevels();
}

// Levels render
function renderLevels() {
  const listDiv = document.getElementById("levelList");
  if (!listDiv) return;
  listDiv.innerHTML = "";
  levels.forEach((l, i) => {
    listDiv.innerHTML += `<div>
      #${l.rank} ${l.name} — ${l.creator} | Points: ${l.points}
      <button onclick="deleteLevel(${i})">Delete</button>
    </div>`;
  });
}

// Level sil
function deleteLevel(i) {
  if (!confirm("Delete this level?")) return;
  const removed = levels.splice(i, 1)[0];
  records = records.filter(r => r.levelId.toString() !== removed.id.toString());
  localStorage.setItem("levels", JSON.stringify(levels));
  localStorage.setItem("records", JSON.stringify(records));
  renderLevels();
  alert("Level deleted");
}

// Record onay/reject fonksiyonları
function approve(i) {
  const record = records[i];
  const level = levels.find(l => l.id.toString() === record.levelId.toString());
  if (!level) return alert("Level not found");

  let player = leaderboard.find(p => p.nick === record.nick);
  if (!player) {
    player = { nick: record.nick, points: 0, completed: [], firstVictories: [] };
    leaderboard.push(player);
  }

  player.points += Number(level.points) || 0;
  if (!player.completed.includes(level.name)) player.completed.push(level.name);

  const approvedRecordsForLevel = records.filter(r => r.levelId.toString() === level.id.toString() && r.approved);
  if (approvedRecordsForLevel.length === 0) {
    player.firstVictories.push(level.name);
    record.isFirst = true;
  }

  record.approved = true;
  localStorage.setItem("records", JSON.stringify(records));
  localStorage.setItem("leaderboard", JSON.stringify(leaderboard));

  alert("Record approved + points added");
  location.reload();
}

function reject(i) {
  records.splice(i, 1);
  localStorage.setItem("records", JSON.stringify(records));
  alert("Record rejected");
  location.reload();
}
</script>

</body>
</html>
